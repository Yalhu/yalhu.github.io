<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">





  <link rel="alternate" href="/atom.xml" title="Yalhu" type="application/atom+xml">






<meta name="description" content="微前端架构是一种类似于微服务的架构，它将微服务的理念应用于浏览器端，即将 Web 应用由单一的单体应用转变为多个小型前端应用聚合为一的应用。   采用不同 JavaScript 技术框架的多个团队中协同构建一个现代化前端 Web 应用所需要的技术、策略和方法。 qiankun: https://qiankun.umijs.org/zh/guide">
<meta property="og:type" content="article">
<meta property="og:title" content="微前端和Qiankun">
<meta property="og:url" content="http://yoursite.com/sum/jsplus/微前端和qiankun/index.html">
<meta property="og:site_name" content="Yalhu">
<meta property="og:description" content="微前端架构是一种类似于微服务的架构，它将微服务的理念应用于浏览器端，即将 Web 应用由单一的单体应用转变为多个小型前端应用聚合为一的应用。   采用不同 JavaScript 技术框架的多个团队中协同构建一个现代化前端 Web 应用所需要的技术、策略和方法。 qiankun: https://qiankun.umijs.org/zh/guide">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2021-07-31T03:57:25.264Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="微前端和Qiankun">
<meta name="twitter:description" content="微前端架构是一种类似于微服务的架构，它将微服务的理念应用于浏览器端，即将 Web 应用由单一的单体应用转变为多个小型前端应用聚合为一的应用。   采用不同 JavaScript 技术框架的多个团队中协同构建一个现代化前端 Web 应用所需要的技术、策略和方法。 qiankun: https://qiankun.umijs.org/zh/guide">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"right","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/sum/jsplus/微前端和qiankun/">





  <title>微前端和Qiankun | Yalhu</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-right page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Yalhu</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">yalhu's blob</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-heartbeat"></i> <br>
            
            公益404
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/sum/jsplus/微前端和qiankun/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Yalhu">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/robbot.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Yalhu">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">微前端和Qiankun</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-01-12T08:00:00+08:00">
                2021-01-12
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2021-07-31T11:57:25+08:00">
                2021-07-31
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/sum/" itemprop="url" rel="index">
                    <span itemprop="name">sum</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/sum/jsplus/" itemprop="url" rel="index">
                    <span itemprop="name">jsplus</span>
                  </a>
                </span>

                
                
              
            </span>
          
          
          
            
          

          
          
             <span id="/sum/jsplus/微前端和qiankun/" class="leancloud_visitors" data-flag-title="微前端和Qiankun">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数&#58;</span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6,684
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  24
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <blockquote>
<p>微前端架构是一种类似于微服务的架构，它将微服务的理念应用于浏览器端，即将 Web 应用由单一的单体应用转变为多个小型前端应用聚合为一的应用。</p>
</blockquote>
<!-- 将微服务的概念扩展到了前端领域。 -->
<p>采用不同 JavaScript 技术框架的多个团队中协同构建一个现代化前端 Web 应用所需要的技术、策略和方法。<br><!-- $_PS: 可以理解为一种架构。多项目或团队，（跨）技术 解决方式。 并不限定组织方式，可以自由实现。 --></p>
<p>qiankun: <a href="https://qiankun.umijs.org/zh/guide" target="_blank" rel="noopener">https://qiankun.umijs.org/zh/guide</a><br><a id="more"></a></p>
<p style="text-align:right"> 2020.12 星期二  ： </p><br><p style="text-align:right"> 2021.7.17 星期六  23：33 </p><br><!-- 有实践基础后，再回头看看 --><br><br>总结：还是要回到业务本身。包括微前端框架的使用方式 和 实现上。<br>一千个读者一千个哈姆雷特。<br><br># 概念<br><!-- \# [微前端概念](http://www.uml.org.cn/AJAX/201907111.asp) --><br>微前端这个术语最初来自 2016 年的 ThoughtWorks 技术雷达[ <a href="https://www.thoughtworks.com/radar/techniques/micro-frontends" target="_blank" rel="noopener">https://www.thoughtworks.com/radar/techniques/micro-frontends</a> ]，它将微服务的概念扩展到了前端领域。目前的趋势是构建一个功能丰富且强大的前端应用，即单页面应用(SPA)，其本身一般都是建立在一个微服务架构之上。前端层通常由一个单独的团队开发，随着时间的推移，会变得越来越庞大而难以维护。这就是传说中的前端巨无霸<a href="https://www.youtube.com/watch?v=pU1gXA0rfwc" target="_blank" rel="noopener">Frontend Monolith</a>。<br><br>微前端背后的理念是将一个网站或者 Web App 当成特性的组合体，每个特性都由一个独立的团队负责。每个团队都有擅长的特定业务领域或是它关心的任务。这里，一个团队是跨职能的，它可以端到端，从数据库到用户界面完整的开发它所负责的功能。<br><br>然而，这个概念并不新鲜，过去它叫针对垂直系统的前端一体化或独立系统。不过微前端显然是一个更加友好并且不那么笨重的术语。<br><br>一体化的前端 VS 垂直化组织方式<br>DOM 就是 API; 页面组合;基本原型;如何创建一个自定义元素<br>浏览器支持;框架兼容性;子父元素或兄弟元素通信 / DOM 事件<br>服务端渲染 / 通用渲染;自定义元素 + 服务端包含(Includes).<br><br># qiankun<br>qiankun: <a href="https://qiankun.umijs.org/zh/guide" target="_blank" rel="noopener">https://qiankun.umijs.org/zh/guide</a><br>qiankun 是一个基于 single-spa 的微前端实现库，旨在帮助大家能更简单、无痛的构建一个生产可用微前端架构系统。<br><br>## 什么是微前端<br>&gt; Techniques, strategies and recipes for building a modern web app with multiple teams that can ship features independently. – Micro Frontends<br>&gt; 微前端是一种多个团队通过独立发布功能的方式来共同构建现代化 web 应用的技术手段及方法策略。<br><br><br>微前端架构具备以下几个核心价值：<br>技术栈无关<br>主框架不限制接入应用的技术栈，微应用具备完全自主权<br><br>独立开发、独立部署<br>微应用仓库独立，前后端可独立开发，部署完成后主框架自动完成同步更新<br><br>增量升级<br>在面对各种复杂场景时，我们通常很难对一个已经存在的系统做全量的技术栈升级或重构，而微前端是一种非常好的实施渐进式重构的手段和策略<br><br>独立运行时<br>每个微应用之间状态隔离，运行时状态不共享<br><br>## 为什么不是 iframe<br><br>## qiankun 技术图<br>### 特性<br><!-- \#22 [qiankun的使用](https://blog.csdn.net/gaomeng965/article/details/105683822) --><br><em> 基于 single-spa 封装，提供了更加开箱即用的 API
</em> 技术栈无关，任意技术栈的应用均可 使用/接入，不论是 React/Vue/Angular/JQuery 还是其他等框架。<br><em> HTML Entry 接入方式。接入微应用像使用 iframe 一样简单
</em> 样式隔离，确保微应用之间样式互相不干扰。<br><em> JS 沙箱，确保微应用之间 全局变量/事件 不冲突。
</em> 资源预加载，在浏览器空闲时间预加载未打开的微应用资源，加速微应用打开速度。<br><em> umi 插件，提供了 @umijs/plugin-qiankun 供 umi 应用一键切换成微前端架构系统。<br><br>### 使用场景<br>项目很多，规模很大，都是每个项目独立使用git此类仓库维护的、技术栈为vue/react/angular的这类应用<br>需要整合到统一平台上，你正在寻找可能比iframe更合适的替代方案<br>项目A有功能A1、A2、A3,项目B有功能B1、B2、B3，产品经理要你把A2、B1、B3组合成一个包含这些功能的新项目<br><!-- End: #22 --><br><br><!-- 
### 框架选择
简单：任意 js 框架均可使用。微应用接入像使用接入一个 iframe 系统一样简单，但实际不是 iframe。
完备：几乎包含所有构建微前端系统时所需要的基本能力，如 样式隔离、js 沙箱、预加载等。
生产可用：已在蚂蚁内外经受过足够大量的线上系统的考验及打磨，健壮性值得信赖 
--><br><br>## 常见问题<br>### 在主应用的某个路由页面加载微应用<br>### 微应用加载的资源会 404<br>原因是 webpack 加载资源时未使用正确的 publicPath。<br>a. 使用 webpack 运行时 publicPath 配置<br>b. 使用 webpack 静态 publicPath 配置<br>### 微应用打包之后 css 中的字体文件和图片加载 404<br>五种解决方式。<br>1. cdn。<br>2. url-loader:base64.<br>3. 借助 webpack 的 file-loader ，在打包时给其注入完整路径（适用于字体文件和图片体积比较大的项目）<br>4. 将两种方案结合起来，小文件转 base64 ，大文件注入路径前缀<br>5. vue-cli3 项目可以将 css 打包到 js里面，不单独生成文件(不推荐，仅适用于 css 较少的项目)<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  css: &#123;</span><br><span class="line">    extract: <span class="literal">false</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><br><br><!-- $_PS: 偏偏就用了5.后台系统，用了element-ui 框架。样式也都写在html 中。 --><br>### 静态资源一定要支持跨域<br>由于 qiankun 是通过 fetch 去获取微应用的引入的静态资源的，所以必须要求这些静态资源支持跨域。<br>### 主应用跟微应用之间的样式隔离<br><!-- [qiankun.js主子应用样式互相影响解决方案](https://www.it610.com/article/1292385024225648640.htm)
解决方案
沙箱？
约定（君子协议）
 --><br>qiankun 将会自动隔离微应用之间的样式（开启沙箱的情况下），你可以通过手动的方式确保主应用与微应用之间的样式隔离。<br>### 独立运行微应用<br>有些时候我们希望直接启动微应用从而更方便的开发调试.可以使用这个全局变量来区分当前是否运行在 qiankun 的主应用的上下文中 <code>window.__POWERED_BY_QIANKUN__</code><br>### 取出公共的依赖库<br>&gt; 不要共享运行时，即便所有的团队都是用同一个框架。<br><!-- $_PS: 为了提高打包和资源加载效率，‘无知’的用external 抽离了公共的依赖。| 统一的技术栈  --><br><!-- $_PS: 确实有一些版本问题。比如，vue 和 vue-template-loader 等版本不一致，包括多个应用之间 --><br>### 微应用之间如何跳转<br><br><br># Ⅰ可能是你见过最完善的微前端解决方案<br><!-- [[可能是你见过最完善的微前端解决方案]](https://zhuanlan.zhihu.com/p/78362028) --><br>## 行业现状<br>传统的云控制台应用，几乎都会面临业务快速发展之后，单体应用进化成巨石应用的问题。为了解决产品研发之间各种耦合的问题，大部分企业也都会有自己的解决方案。笔者于17年底，针对国内外几个著名的云产品控制台，做过这样一个技术调研：<br><br>MPA 方案的优点在于 部署简单、各应用之间硬隔离，天生具备技术栈无关、独立开发、独立部署的特性。缺点则也很明显，应用之间切换会造成浏览器重刷，由于产品域名之间相互跳转，流程体验上会存在断点。<br>SPA 则天生具备体验上的优势，应用直接无刷新切换，能极大的保证多产品之间流程操作串联时的流程性。缺点则在于各应用技术栈之间是强耦合的。<br>那我们有没有可能将 MPA 和SPA 两者的优势结合起来，构建出一个相对完善的微前端架构方案呢？<br>jsconf china 2016 大会上，ucloud 的同学分享了他们的基于 angularjs 的方案（单页应用“联邦制”实践），里面提到的 “联邦制” 概念很贴切，可以认为是早期的基于耦合技术栈的微前端架构实践。<br><br>## 微前端架构实践中的问题<br>### 路由系统及 FutureStat<br>### App Entry<br>解决了路由问题后，主框架与子应用集成的方式，也会成为一个需要重点关注的技术决策。<br>1. 构建时组合 VS 运行时组合<br>2. JS Entry vs HTMLEntry<br>3. 模块导入<br>### 应用隔离<br>1. 样式隔离<br>Shadow DOM？<br>CSS Module? BEM?<br>Dynamic Stylesheet !<br>2. JS 隔离<br>即在应用的 bootstrap 及 mount 两个生命周期开始之前分别给全局状态打下快照<br><br>## 蚂蚁金服微前端落地实践<br>在内部得到充分的技术验证和线上考验之后，我们决定将这套解决方案开源出来！<br><br>qiankun - 一套完整的微前端解决方案<br><a href="https://github.com/umijs/qiankun" target="_blank" rel="noopener">https://github.com/umijs/qiankun</a><br>取名 qiankun，意为统一。我们希望通过 qiankun 这种技术手段，让你能很方便的将一个巨石应用改造成一个基于微前端架构的系统，并且不再需要去关注各种过程中的技术细节，做到真正的开箱即用和生产可用。<br><br><br>先是qiankun 掌握其根本，然后是mooa 了解其历程。<br>第三个是meituan的两个方案。第四是基于singleSpa，qiankun 讨论微前端实现方式。<br>倒数第二总结一下微前端，做了哪些工作，来获得收益；或者弊端。<br>最后再回顾一下实现微前端的六种方式。<br><br>排名不分先后<!-- ，按照方便学习的方式 --><br># Ⅱ 微前端的那些事儿<br><!-- [[微前端的那些事儿]](https://blog.csdn.net/qappleh/article/details/80928434) --><br>实施微前端的六种方式<br>  基础铺垫：应用分发路由 -&gt; 路由分发应用<br>    后端：函数调用 -&gt; 远程调用<br>    前端：组件调用 -&gt; 应用调用<br>  路由分发式微前端<br>  使用 iFrame 创建容器<br>  自制框架兼容应用<br>  组合式集成：将应用微件化<br>  纯 Web Components 技术构建<br>  结合 Web Components 构建<br>    在 Web Components 中集成现有框架<br>    集成在现有框架中的 Web Components<br>  复合型<br><br>为什么微前端开始在流行——Web 应用的聚合<br>  前端遗留系统迁移<br>  后端解耦，前端聚合<br>  兼容遗留系统<br>如何解构单体前端应用——前端应用的微服务式拆分<br>  前端微服化<br>    独立开发<br>    独立部署<br>    我们真的需要技术无关吗？<br>    不影响用户体验<br>  微前端的设计理念<br>    设计理念一：中心化路由<br>    设计理念二：标识化应用<br>    设计理念三：生命周期<br>    设计理念四：独立部署与配置自动化<br>  实战微前端架构设计<br>    独立部署与配置自动化<br>    应用间路由——事件<br><br><br>大型 Angular 应用微前端的四种拆分策略<br>  前端微服务化：路由懒加载及其变体<br>  微服务化方案：子应用模式<br>  方案对比<br>    标准 LazyLoad<br>    LazyLoad 变体 1：构建时集成<br>    LazyLoad 变体 2：构建后集成<br>  前端微服务化<br>  总对比<br><br><br>前端微服务化：使用微前端框架 Mooa 开发微前端应用<br>  Mooa 概念<br>  微前端主工程创建<br>  Mooa 子应用创建<br>  导航到特定的子应用<br><br>前端微服务化：使用特制的 iframe 微服务化 Angular 应用<br>  iframe 微服务架构设计<br>  微前端框架 Mooa 的特制 iframe 模式<br>  微前端框架 Mooa iframe 通讯机制<br>    发布主应用事件<br>    监听子应用事件<br>  示例<br><br><br># Ⅲ 微前端在美团外卖的实践<br><!-- [[微前端在美团外卖的实践]](https://tech.meituan.com/2020/02/27/meituan-waimai-micro-frontends-practice.html) --><br>## 背景<br>外卖商家广告端的业务形态。目前，我们开发和维护的系统主要包括三端：<br>PC系统：单门店投放系统PC端<br>H5系统：单门店投放系统H5端<br>KA系统：多门店投放系统PC端<br>如上图所示，原始解决方案的三端由各自独立开发和维护，各自包含所有的业务线，而我们的业务开发情况是：<br><br>PC端和H5端相同业务线的基本业务逻辑一致，UI差异大。<br>PC端和KA端相同业务线的部分业务逻辑一致，UI差异小。<br><br>就有两个问题摆在我们面前：<br><br>如何进行物理层面的复用（不同端的代码在不同地址的Git仓库）。<br>如何进行逻辑层面的复用（不同端的相同逻辑如何使用一份代码进行抽象）。<br><br>## 方案选择<br>经过以上的需求分析，我们调研了业界及公司周边的微前端方案，并总结了以下几种方案以及它们各自主要的特点：<br><br>NPM式：子工程以NPM包的形式发布源码；打包构建发布还是由基座工程管理，打包时集成。<br>iframe式：子工程可以使用不同技术栈；子工程之间完全独立，无任何依赖；基座工程和子工程需要建立通信机制；无单页应用体验；路由地址管理困难。<br>通用中心路由基座式：子工程可以使用不同技术栈；子工程之间完全独立，无任何依赖；统一由基座工程进行管理，按照DOM节点的注册、挂载、卸载来完成。<br>特定中心路由基座式：子业务线之间使用相同技术栈；基座工程和子工程可以单独开发单独部署；子工程有能力复用基座工程的公共基建。<br>## 微前端实践概览<br>## 微前端架构下的业务变化<br>## 基于React技术栈的中心路由基座式微前端<br>### 动态化方案<br>动态路由<br>动态Store<br>动态CSS<br><br>### 路由配置信息方案<br>### 子工程接口方案<br>### 复用方案<br>### 流程方案<br>开发流程<br>热更新<br>Mock数据<br><br><br>### 部署方案<br>### 回滚方案<br>### 监控方案<br><br><br># Ⅲ 用微前端的方式搭建类单页应用<br><!-- [[用微前端的方式搭建类单页应用]](https://tech.meituan.com/2018/09/06/fe-tiny-spa.html) --><br>## 前言<br>微前端由ThoughtWorks 2016年提出，将后端微服务的理念应用于浏览器端，即将 Web 应用由单一的单体应用转变为多个小型前端应用聚合为一的应用。<br>我们把这种由多个微前端聚合出来的单页应用叫做“类单页应用”，美团HR系统就是基于这种设计实现的。美团HR系统是由30多个微前端应用聚合而成，包含1000多个页面，300多个导航菜单项。对用户来说，HR系统是一个单页应用，整个交互过程非常顺畅；对开发者同学来说，各个应用均可独立开发、独立测试、独立发布，大大提高了开发效率。<br><br>接下来，本文将为大家介绍“微前端构建类单页应用”在美团HR系统中的一些实践。同时也分享一些我们的思考和经验，希望能够对大家有所启发。<br>## HR系统的微前端设计<br>一般而言，“类单页应用”的实现方式主要有两种：<br><br>iframe嵌入<br>微前端合并类单页应用<br>### 一个前端对应多个后端<br>“Portal项目”是比较特殊的，在开发阶段是一个容器，不包含任何业务，除了提供“子项目”注册、合并功能外，还可以提供一些系统级公共支持，例如：<br><br>转发规则上限制数据请求格式必须是 系统名+Api做前缀 这样保障了各个系统之间的请求可以完全隔离。其中，Nginx的配置示例如下：<br>### 应用注册机制<br>#### 路由注册<br>#### 项目作用域控制<br>window.app主要功能：<br>define 定义项目的公共库，主要用来解决JS公共库的管理问题<br>require 引用自己的定义的基础库，配合define来使用<br>routes 用于存放全局的路由，子项目路由添加到window.app.routes，用于完成路由的注册<br>init 注册入口，为子项目添加上namesapce标识，注册上子项目管理数据流的reducers<br><br>#### CSS作用域方面<br>使用webpack在构建阶段为业务的所有CSS都加上自己的作用域<br>#### JS公共库版本统一<br><br>### 构建后集成和独立部署<br>在HR系统的整合过程中，开发阶段对“子项目”是“零侵入”，而在发布阶段，我们也希望如此。<br><br># Ⅳ 你必须要会的微前端<br><!-- \#1 [2020年你必须要会的微前端 -（实战篇）](https://blog.csdn.net/webyouxuan/article/details/107603165) --><br><br><ol><li class><a href="#t1">一.为什么需要微前端?</a></li><li class="sub-box"><ol><li class><a href="#t2">1.What?什么是微前端?</a></li><li class><a href="#t3">2.Why?为什么去使用他?</a></li><li class><a href="#t4">3.How?怎样落地微前端?</a></li></ol></li><li class><a href="#t5">二 .SingleSpa实战</a></li><li class="sub-box"><ol><li class><a href="#t6">1.构建子应用</a></li><li class><a href="#t7">2.配置库打包</a></li><li class><a href="#t8">3.主应用搭建</a></li><li class><a href="#t9">4.动态设置子应用publicPath</a></li></ol></li><li class><a href="#t10">三.qiankun实战</a></li><li class="sub-box"><ol><li class><a href="#t11">1.主应用编写</a></li><li class><a href="#t12">2.注册子应用</a></li><li class="active"><a href="#t13">3.子Vue应用</a></li><li class><a href="#t14">4.子React应用</a></li></ol></li><li class><a href="#t15">四.CSS隔离方案</a></li><li class><a href="#t16">五.JS沙箱机制</a></li><li class="sub-box"><ol><li class><a href="#t17">1.快照沙箱</a></li><li class><a href="#t18">2.Proxy 代理沙箱</a></li></ol></li></ol><br><br>## 一.为什么需要微前端?<br>1.What?什么是微前端?<br>2.Why?为什么去使用他?<br>3.How?怎样落地微前端?<br>### 应用间如何通信？<br>基于URL来进行数据传递，但是这种传递消息的方式能力较弱；<br>基于CustomEvent实现通信；<br>基于props主子应用间通信；<br>使用全局变量、Redux进行通信。<br><br>### 如何处理公共依赖？<br>CDN - externals<br>webpack联邦模块<br>## 二 .SingleSpa实战<br>## 三.qiankun实战<br>四.CSS隔离方案<br>子应用之间样式隔离：<br>Dynamic Stylesheet动态样式表，当应用切换时移除掉老应用样式，再添加新应用样式，保证在一个时间点内只有一个应用的样式表生效<br><br>主应用和子应用之间的样式隔离：<br>BEM(Block Element Modifier)  约定项目前缀<br>CSS-Modules 打包时生成不冲突的选择器名<br>Shadow DOM 真正意义上的隔离<br>css-in-js<br>## 五.JS沙箱机制<br>运行子应用时应该跑在内部沙箱环境中<br><br>快照沙箱，当应用沙箱挂载或卸载时记录快照，在切换时依据快照恢复环境 (无法支持多实例)<br>&gt; 快照沙箱只能针对单实例应用场景，如果是多个实例同时挂载的情况则无法解决，这时只能通过Proxy代理沙箱来实现<br>Proxy 代理沙箱，不影响全局环境<br>&gt; 每个应用都创建一个proxy来代理window对象，好处是每个应用都是相对独立的，不需要直接更改全局的window属性。<br><br><!-- End: #1 --><br><br># Ⅸ 微前端到底是什么<br><!-- [[微前端到底是什么？]](https://zhuanlan.zhihu.com/p/96464401) --><br>本文首发于 ayqy.net ，原文链接：<a href="http://www.ayqy.net/blog/micro-frontends/" target="_blank" rel="noopener">http://www.ayqy.net/blog/micro-frontends/</a><br><br>## 一.简介<br>## 二.特点<br>将庞大的整体拆成可控的小块，并明确它们之间的依赖关系。关键优势在于：
</em> 代码库更小，更内聚、可维护性更高<br><em> 松耦合、自治的团队可扩展性更好
</em> 渐进地升级、更新甚至重写部分前端功能成为了可能<br><br>简单、松耦合的代码库<br>增量升级<br>独立部署<br>团队自治<br><br>## 三.实现方案<br>实现上，关键问题在于：<br><br>多个 Bundle 如何集成？<br>  集成方式分为 3 类：<br>  服务端集成：如 SSR 拼装模板<br>  构建时集成：如 Code Splitting<br>  运行时集成：如通过 iframe、JS、Web Components 等方式<br><br>子应用之间怎样隔离影响？<br>  样式隔离：开发规范（如BEM）、CSS 预处理（如SASS）、模块定义（如CSS Module）、用 JS 来写（CSS-in-JS）、以及shadow DOM特性<br>  作用域隔离：各种模块定义（如ES Module、AMD、Common Module、UMD）<br><br><br>公共资源如何复用？<br>  资源复用对于 UI 一致性和代码复用有重要意义，但并非所有的可复用资源（如组件）都必须在一<br>  另一方面，资源分为以下 3 类：<br>    基础资源：完全不含逻辑功能的图标、标签、按钮等<br>    UI 组件：含有一定 UI 逻辑的搜索框（如自动完成）、表格（如排序、筛选、分页）等<br>    业务组件：含有业务逻辑<br><br>  其中，不建议跨子应用复用业务组件，因为会造成高度耦合，增加变更成本<br>  对于公共资源的归属和管理，一般有两种模式：<br>    公共资源归属于所有人，即没有明确归属<br>    公共资源归集中管理，由专人负责<br><!-- 
从实践经验来看，前者很容易衍变成没有明确规范，且背离技术愿景的大杂烩，而后者会造成资源创建和使用的脱节，比较推荐的模式是开源软件的管理模式：

> Anyone can contribute to the library, but there is a custodian (a person or a team) who is responsible for ensuring the quality, consistency, and validity of those contributions.
即，所有人都能补充公共资源，但要有人（或一个团队）负责监管，以保证质量、一致性以及正确性
 --><br>子应用间怎样通信？<br><br><br>如何测试？<br>  每个子应用都应该有自己的全套测试方案，特殊之处在于，除单元测试、功能测试外，还要有集成测试：<br>## 四.示例<br>在线 Demo：<a href="https://demo.microfrontends.com/" target="_blank" rel="noopener">https://demo.microfrontends.com/</a><br>源码地址：micro-frontends-demo/container<br>详细介绍：The example in detail<br><br><br>## 五.缺点<br>导致依赖项冗余，增加用户的流量负担<br>团队自治程度的增加，可能会破坏协作<br><br>## 六.总结<br><br><br># Ⅹ 实施微前端的六种方式<br><!-- \#2 [[实施微前端的六种方式]](https://segmentfault.com/a/1190000015566927) --><br>结合我最近半年在微前端方面的实践和研究来看，微前端架构一般可以由以下几种方式进行：<br><em> 使用 HTTP 服务器的路由来重定向多个应用
</em> 在不同的框架之上设计通讯、加载机制，诸如 Mooa 和 Single-SPA<br><em> 通过组合多个独立应用、组件来构建一个单体应用
</em> iFrame。使用 iFrame 及自定义消息传递机制<br><em> 使用纯 Web Components 构建应用
</em> 结合 Web Components 构建<br><br>## 基础铺垫：应用分发路由 -&gt; 路由分发应用<br>后端：函数调用 -&gt; 远程调用<br>### 前端：组件调用 -&gt; 应用调用<br>## 路由分发式微前端<br>在这个示例里，不同的页面的请求被分发到不同的服务器上。<br>随后，我们在别的项目上也使用了类似的方式，其主要原因是：跨团队的协作。<br>因此在这种情况下，它适用于以下场景<br>## 使用 iFrame 创建容器<br>网站不需要 SEO 支持<br>拥有相应的应用管理机制。<br>设计管理应用机制<br>设计应用通讯机制<br>## 自制框架兼容应用<br>尽管 Single-SPA 已经拥有了大部分框架（如 React、Angular、Vue 等框架）的启动和卸载处理，但是它仍然不是适合于生产用途。当我基于 Single-SPA 为 Angular 框架设计一个微前端架构的应用时，我最后选择重写一个自己的框架，即 Mooa。<br>## 组合式集成：将应用微件化<br>## 纯 Web Components 技术构建<br>在添加了一些基本的 Web 前端框架的功能之后，我发现这项技术特别适合于作为<strong>微前端的基石</strong>。<br><br>Web Components 是一套不同的技术，允许您创建可重用的定制元素（它们的功能封装在您的代码之外）并且在您的 Web 应用中使用它们。<br>它主要由四项技术组件：<br><br>1）Custom elements，允许开发者创建自定义的元素，诸如 <code>&lt;today-news&gt;&lt;/today-news&gt;</code>。<br>2）Shadow DOM，即影子 DOM，通常是将 Shadow DOM 附加到主文档 DOM 中，并可以控制其关联的功能。而这个 Shadow DOM 则是不能直接用其它主文档 DOM 来控制的。<br>3）HTML templates，即<code>&lt;template&gt;</code> 和<code>&lt;slot&gt;</code> 元素，用于编写不在页面中显示的标记模板。<br>4）HTML Imports，用于引入自定义组件。<br><!-- End: #2 --><br><br><br># 万字长文+图文并茂+全面解析微前端框架 qiankun 源码 - qiankun 篇<br><!-- [[万字长文+图文并茂+全面解析微前端框架 qiankun 源码 - qiankun 篇]](https://blog.csdn.net/qq_34621851/article/details/105341137) --><br>初始化全局配置 - start(opts)<br>注册子应用 - registerMicroApps(apps, lifeCycles?)<br>获取子应用资源 - import-html-entry<br>主应用挂载子应用 HTML 模板<br>沙箱运行环境 - genSandbox<br>LegacySandbox<br>多实例沙箱 - ProxySandbox<br>SnapshotSandbox<br>挂载沙箱 - mountSandbox<br>计时器劫持 - patchTimer<br>动态添加样式表和脚本文件劫持 - patchDynamicAppend<br>卸载沙箱 - unmountSandbox<br>注册内部生命周期函数<br>触发 beforeLoad 生命周期钩子函数<br>进入到 mount 挂载流程<br>进入到 unmount 卸载流程<br><br>最后一件事<br>这篇文章我花了大约半个月的时间来进行排版、梳理、画图，坚持下来一路写完确实很不容易。<br><br><br><br># 微前端的核心价值<br><!-- \#1 [微前端的核心价值](https://zhuanlan.zhihu.com/p/95085796) --><br>&gt; 如果是 widget 级别，那么微前端跟业务组件的区别在哪里？微前端到底是因何而生？<br>我的观点：有没有区别在于你的实现是不是技术栈无关。<br><br>我认为微前端的核心价值在于 <strong>“技术栈无关”</strong>，这才是它诞生的理由，或者说这才是能说服我采用微前端方案的理由。<br><br>## 为什么”技术栈无关”这么重要？<br>## 为什么我认为”技术栈无关”才是微前端的初衷？<br>&gt; 微前端的初衷应该还是来解决工程问题的，带来的产品价值在不同的领域可大可小。 比如在阿里云这种典型的云产品控制台的场景下，它带来的产品价值就会很可观。<br><br>&gt; 今天看各 BU 的业务问题，微前端的前提，还是得有主体应用，然后才有微组件或微应用，解决的是可控体系下的前端协同开发问题（含空间分离带来的协作和时间延续带来的升级维护）<br>## 微前端方案正确的架构姿势<br>「技术栈无关」是架构上的准绳，具体到实现时，对应的就是：应用之间不应该有任何直接或间接的技术栈、依赖、以及实现上的耦合。<br><br><br>qiankun 正是以此为准则设计的。<br>如果说阿里的企业使命是：「让天下没有难做的生意」。<br>那么微前端的使命我认为是：「让天下没有短命的控制台」。<br><br>&gt; 事实上如果所有的 web 技术栈能做到统一，所有 library 的升级都能做到向下兼容，我们确实就不需要微前端了。 —— 鲁迅<br><br>## 评论<br>&gt; 最终解决方案还要看web component<br>&gt; 技术栈无关这个优点说实话是非常。。emmm。怎么说呢，非常的自我安慰。<br>&gt; 很多同学纠结于 web components。微前端的最大的优势，是技术无关性。web components 是一种具体的技术，而三大框架也是具体的技术。后者明显比裸写 web components 要香的多了。<br><br>&gt; 结合 Web Components 构建是一种面向未来演进的架构。或者说在未来的时候，我们可以开始采用这种方式来构建我们的应用。目前没有采用的原因是遗留系统下IE的兼容性问题。（至少目前选择类似乾坤的方式是有这方面的原因<br>三大框架中除了react之外，都已经算是拥抱 Web Components 了。ng 用起来更是不像外部组件。<br>&gt; 类似于 Stencil 的形式，将组件直接构建成 Web Components 形式的组件，随后在对应的诸如， React 或者 Angular 中直接引用。其实也是很好的解决方式。<br><br>&gt; 最后还想提问一句， 微前端带来的spa体验对比与 MPA 路由组合带来的体验提升了多少？ 对于用户真的有感知吗？ 如何衡量这里的价值？<br><br><!-- > 为我的微前端框架obvious.js打个小广告，感兴趣的朋友可以一起学习交流，附上详细的文档和教程地址：https://run-nan.github.io/obvio... --><br><br><br><br><br><br><!-- 
## 其他
[了解什么是微前端](https://www.jianshu.com/p/beb09e3a748e)
整体结构和一些术语
要解决的问题:
客户端
编排
路由
隔离微应用
应用之间通信
微应用UI之间的一致性
服务端
服务端渲染
路由
依赖管理
灵活、强大而简单的架构 

[微前端实践](https://www.jianshu.com/p/41ab812df9e7)
首先是打包速度。在 6 个月前，我们的 B 端工程那会儿还是一个 Monolith。当时已经有 20 多个依赖、60 多个公共组件、200 多个页面，对接 700 多个接口。



~~[微前端框架整体架构思路](https://www.360kuai.com/pc/9bf295071b6c6ccd5?cota=4&kuai_so=1&tj_url=so_rec&sign=360_57c3bbd1&refer_scene=so_1)~~
$_PS: 样式都乱。内容也较少
--><br><br><p style="text-align:right"> </p>


      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>knowledge is no pay,reward is kindness</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="Yalhu 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Yalhu 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        

      </div>
    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/sum/jsplus/rollup第一次使用/" rel="next" title="Rollup第一次使用">
                <i class="fa fa-chevron-left"></i> Rollup第一次使用
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/sum/js/web性能优化指南/" rel="prev" title="Web性能优化指南">
                Web性能优化指南 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
<span class="jiathis_txt">分享到：</span>
<a class="jiathis_button_fav">收藏夹</a>
<a class="jiathis_button_copy">复制网址</a>
<a class="jiathis_button_email">邮件</a>
<a class="jiathis_button_weixin">微信</a>
<a class="jiathis_button_qzone">QQ空间</a>
<a class="jiathis_button_tqq">腾讯微博</a>
<a class="jiathis_button_douban">豆瓣</a>
<a class="jiathis_button_share">一键分享</a>

<a href="http://www.jiathis.com/share?uid=2140465" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank">更多</a>
<a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript">
var jiathis_config={
  data_track_clickback:true,
  summary:"",
  shortUrl:false,
  hideMore:false
}
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=" charset="utf-8"></script>
<!-- JiaThis Button END -->
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      
        <div id="gitment-container"></div>
      
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/robbot.jpg" alt="Yalhu">
            
              <p class="site-author-name" itemprop="name">Yalhu</p>
              <p class="site-description motion-element" itemprop="description">no better,but great !</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">339</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">44</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="mailto:xxxx@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          
            <div class="cc-license motion-element" itemprop="license">
              <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
                <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
              </a>
            </div>
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="/home2/" title="Home2" target="_blank">Home2</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="/archives2/" title="Archives2" target="_blank">Archives2</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="/acategories/" title="Acategories" target="_blank">Acategories</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2016 &mdash; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Yalhu</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">572.1k</span>
  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  







<!-- LOCAL: You can save these files to your site and update links -->
    
        
        <link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css">
        <script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script>
    
<!-- END LOCAL -->

    
      <style>
        a.gitment-editor-footer-tip { display: none; }
        .gitment-container.gitment-footer-container { display: none; }
      </style>
    

    
      <script type="text/javascript">
      function renderGitment(){
        var gitment = new Gitmint({
            id: window.location.pathname, 
            owner: 'yalhu',
            repo: 'ablobComment',
            
            lang: "zh-Hans" || navigator.language || navigator.systemLanguage || navigator.userLanguage,
            
            oauth: {
            
            
                client_secret: 'e2dffa7f47b9523021b9ae56b08f1a8901ec5b47',
            
                client_id: '55b918d3485e51d807dd'
            }});
        gitment.render('gitment-container');
      }

      
      renderGitment();
      
      </script>
    







  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("FR1Ck8VBxN9d1lKPIOSKmvgl-gzGzoHsz", "bLUjHdwtJTf00J8OwVTT8urs");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  

  
  

  

  

  

</body>
</html>
